{% extends 'base.html' %}

{% block title %}Quét Gương Mặt để Điểm Danh{% endblock %}

{% block extra_css %}
<style>
    .container {
        margin-top: 30px;
    }
    .result p, .actions button {
        margin: 10px 0;
    }
    .result {
        display: none;
    }
    .actions {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="my-4 text-center">Quét Gương Mặt để Điểm Danh</h1>

    <div class="text-center">
        <video id="video" class="mb-3 border border-secondary" width="640" height="480" autoplay></video>
        <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    </div>

    <div id="result" class="alert" role="alert"></div>

    <div id="actions" class="text-center">
        <button id="confirm" class="btn btn-success btn-lg">Xác nhận điểm danh</button>
        <button id="retry" class="btn btn-secondary btn-lg">Thử lại</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Get the elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultDiv = document.getElementById('result');
    const actionsDiv = document.getElementById('actions');
    const context = canvas.getContext('2d');
    const confirmButton = document.getElementById('confirm');
    const retryButton = document.getElementById('retry');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Store the recognized nhanvien ID
    let recognizednhanvienId = null;
    let capturing = true;  // Flag to control capturing

    // Access the camera
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(error => {
            console.error('Error accessing camera:', error);
        });

    // Function to capture image from video and send to server
    function captureAndSendImage() {
        if (!capturing) return; // Stop capturing if already done

        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('image', blob, 'snapshot.png');

            fetch('{% url 'nhan_dien' %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `<p class="mb-0">Nhân viên được xác nhận: <strong>${data.nhanvien.hoten} - ID: ${data.nhanvien.id}</strong></p>`;
                    resultDiv.className = 'alert alert-success';
                    recognizednhanvienId = data.nhanvien.id;
                    actionsDiv.style.display = 'block';
                    capturing = false;  // Stop capturing
                } else {
                    resultDiv.innerHTML = `<p class="mb-0">${data.error_message}</p>`;
                    resultDiv.className = 'alert alert-danger';
                    actionsDiv.style.display = 'block';
                }
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Lỗi:', error);
            });
        }, 'image/png');
    }

    // Start capturing images
    let intervalId = setInterval(captureAndSendImage, 5000);

    // Sự kiện xác nhận điểm danh
    confirmButton.addEventListener('click', () => {
        if (recognizednhanvienId) {
            fetch('{% url 'diem_danh' %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ nhanvien_id: recognizednhanvienId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clearInterval(intervalId);
                    resultDiv.innerHTML = `<p class="mb-0">Điểm danh thành công!</p>`;
                    resultDiv.className = 'alert alert-success';
                    actionsDiv.style.display = 'none';
                } else {
                    resultDiv.innerHTML = `<p class="mb-0">${data.error}</p>`;
                    resultDiv.className = 'alert alert-danger';
                }
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Lỗi:', error);
            });
        }
    });

    // Retry button click event
    retryButton.addEventListener('click', () => {
        resultDiv.innerHTML = '';
        resultDiv.className = 'alert';
        resultDiv.style.display = 'none';
        actionsDiv.style.display = 'none';
        recognizednhanvienId = null;
        capturing = true;  // Restart capturing
        intervalId = setInterval(captureAndSendImage, 5000);  // Restart capturing every 5 seconds
    });
</script>
{% endblock %}
