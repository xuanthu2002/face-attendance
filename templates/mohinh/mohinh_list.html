{% extends 'base.html' %}

{% block title %}Danh Sách Mô Hình{% endblock %}

{% block content %}
<h1 class="my-4">Danh Sách Mô Hình</h1>

<a href="{% url 'mohinh_create' %}" class="btn btn-primary mb-3">Tạo Mô Hình Mới</a>

<form id="mohinh-form" method="post">
    {% csrf_token %}
    <table class="table table-striped table-bordered">
        <thead>
        <tr>
            <th>#</th>
            <th>Tên</th>
            <th>Ngày Train</th>
            <th>Trạng Thái</th>
            <th>Hành Động</th>
        </tr>
        </thead>
        <tbody>
        {% for mohinh in mohinh_list %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ mohinh.ten }}</td>
            <td>{{ mohinh.ngay_train }}</td>
            <td>
                <input type="radio" name="active_status" value="{{ mohinh.id }}"
                       {% if mohinh.active %}checked{% endif %}>
            </td>
            <td>
                <a href="{% url 'mohinh_detail' mohinh.id %}" class="btn btn-info btn-sm">Chi Tiết</a>
                <a href="{% url 'mohinh_edit' mohinh.id %}" class="btn btn-warning btn-sm">Sửa</a>
                <button class="btn btn-danger btn-sm" onclick="confirmDelete('{{ mohinh.id }}')">Xóa</button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center">Không có mô hình nào</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <button type="submit" class="btn btn-primary">Cập Nhật Trạng Thái</button>
</form>

<form id="delete-form" method="post" style="display:none;">
    {% csrf_token %}
</form>
{% endblock %}

{% block extra_js %}
<script>
    function confirmDelete(mohinhId) {
        if (confirm('Bạn có chắc chắn muốn xóa mô hình này không?')) {
            const form = document.getElementById('delete-form');
            form.action = `/mohinh/delete/${mohinhId}/`;
            form.submit();
        }
    }

    document.getElementById('mohinh-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = this;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const activeId = form.querySelector('input[name="active_status"]:checked')?.value;

        if (!activeId) {
            alert('Vui lòng chọn một mô hình làm active.');
            return;
        }

        fetch('{% url "mohinh_update_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ active_id: activeId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Trạng thái đã được cập nhật!');
            } else {
                alert('Có lỗi xảy ra khi cập nhật trạng thái.');
            }
        })
        .catch(error => {
            console.error('Lỗi:', error);
            alert('Có lỗi xảy ra.');
        });
    });
</script>
{% endblock %}
