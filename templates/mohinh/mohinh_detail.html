{% extends 'base.html' %}

{% block title %}Chi Tiết Mô Hình{% endblock %}

{% block content %}
<h1 class="my-4">Chi Tiết Mô Hình: {{ mohinh.ten }}</h1>

<p><strong>Ngày Train:</strong> {{ mohinh.ngay_train }}</p>
<p><strong>Trạng Thái:</strong> {{ mohinh.active|yesno:"Hoạt động,Không hoạt động" }}</p>

<!-- Button to trigger training -->
<button id="trainButton" class="btn btn-primary mt-3">Train Mô Hình</button>

<!-- Spinner for loading state -->
<div id="spinner" class="spinner-border text-primary mt-3" style="display:none;" role="status">
    <span class="sr-only">Loading...</span>
</div>

<h2 class="my-4">Danh Sách Nhân Viên</h2>

<table class="table table-striped table-bordered">
    <thead>
    <tr>
        <th>#</th>
        <th>Nhân Viên</th>
        <th>Hành Động</th>
    </tr>
    </thead>
    <tbody>
    {% for nhanvien in nhanvien_list %}
    <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ nhanvien.hoten }}</td>
        <td>
            <a href="{% url 'nhanvien_mau_list' mohinh.id nhanvien.id %}" class="btn btn-info btn-sm">Xem Mẫu</a>
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="4" class="text-center">Không có nhân viên nào</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Alert container for feedback -->
<div id="feedback" class="alert mt-3" style="display:none;"></div>
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    const mohinhId = {{ mohinh.id }};

    document.getElementById('trainButton').addEventListener('click', () => {
        // Show spinner and hide feedback
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('feedback').style.display = 'none';

        fetch("{% url 'train_mohinh' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ mohinh_id: mohinhId })
        })
        .then(response => response.json())
        .then(data => {
            const feedback = document.getElementById('feedback');
            feedback.style.display = 'block';
            document.getElementById('spinner').style.display = 'none'; // Hide spinner

            if (data.success) {
                feedback.className = 'alert alert-success';
                feedback.innerText = 'Mô hình đã được train thành công!';
            } else {
                feedback.className = 'alert alert-danger';
                feedback.innerText = 'Lỗi: ' + (data.error || 'Có lỗi xảy ra khi train mô hình');
            }
        })
        .catch(error => {
            console.error('Lỗi:', error);
            const feedback = document.getElementById('feedback');
            feedback.style.display = 'block';
            document.getElementById('spinner').style.display = 'none'; // Hide spinner
            feedback.className = 'alert alert-danger';
            feedback.innerText = 'Có lỗi xảy ra khi gửi dữ liệu';
        });
    });
</script>
{% endblock %}
