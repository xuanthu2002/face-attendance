{% extends "base.html" %}

{% block title %}{{ form.instance.pk|yesno:"Sửa Mẫu,Thêm Mẫu" }}{% endblock %}

{% block content %}
<h1 class="my-4">{{ form.instance.pk|yesno:"Sửa Mẫu,Thêm Mẫu" }}</h1>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <input type="file" name="image" id="image-input" accept="image/*" style="display:none;">
    <button type="submit" class="btn btn-primary">Lưu</button>
</form>

<div class="mt-4">
    <h3>Chụp ảnh từ camera</h3>
    <button id="openCamera" class="btn btn-secondary mt-3">Mở Camera</button>
    <div id="cameraSection" class="mt-3" style="display:none;">
        <div class="video-container">
            <video id="video" width="640" height="480" autoplay></video>
        </div>
        <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
        <button id="toggleAutoCapture" class="btn btn-info mt-3">Bật Tự Động Chụp Ảnh</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    let captureInterval;
    let isAutoCapture = false;

    // Function to capture image and send to server
    function captureImage() {
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob((blob) => {
            const formData = new FormData();
            formData.append('link', blob, 'mau_image.jpg');

            fetch('{% url "mau_create" nhanvien.id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Mẫu được thêm thành công');
                } else {
                    console.error('Thêm mẫu thất bại:', data.error);
                }
            })
            .catch(error => {
                console.error('Lỗi:', error);
            });
        });
    }

    // Event listener for the open camera button
    document.getElementById('openCamera').addEventListener('click', () => {
        document.getElementById('cameraSection').style.display = 'block';
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                video.srcObject = stream;
                video.play();
            })
            .catch((err) => {
                console.error("Lỗi khi truy cập camera:", err);
            });
    });

    // Event listener for the auto capture toggle button
    document.getElementById('toggleAutoCapture').addEventListener('click', () => {
        if (isAutoCapture) {
            clearInterval(captureInterval);
            isAutoCapture = false;
            document.getElementById('toggleAutoCapture').innerText = "Bật Tự Động Chụp Ảnh";
        } else {
            captureInterval = setInterval(captureImage, 1000); // Capture every 1 seconds
            isAutoCapture = true;
            document.getElementById('toggleAutoCapture').innerText = "Tắt Tự Động Chụp Ảnh";
        }
    });
</script>
{% endblock %}
