{% extends "base.html" %}

{% block title %}Danh Sách Mẫu của {{ nhanvien.hoten }}{% endblock %}

{% block content %}
<h1 class="my-4">Danh Sách Mẫu của {{ nhanvien.hoten }}</h1>

<a href="{% url 'mau_create' nhanvien.id %}" class="btn btn-primary mb-3">Thêm Mẫu</a>

<table class="table table-striped table-bordered">
    <thead>
    <tr>
        <th>#</th>
        <th>Nhân Viên</th>
        <th>Link</th>
        <th>Ngày Thêm</th>
        <th>Hành Động</th>
    </tr>
    </thead>
    <tbody>
    {% for mau in mau_list %}
    <tr id="mau-{{ mau.id }}">
        <td>{{ forloop.counter }}</td>
        <td>{{ mau.nhanvien.hoten }}</td>
        <td><a href="{{ mau.link.url }}" target="_blank">Xem</a></td>
        <td>{{ mau.ngay_them }}</td>
        <td>
            <button class="btn btn-danger btn-sm" onclick="confirmDelete('{{ mau.id }}')">Xóa</button>
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="5" class="text-center">Không có mẫu nào</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Hidden form for delete action -->
<form id="delete-form" method="post" style="display:none;">
    {% csrf_token %}
</form>
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function confirmDelete(mauId) {
        if (confirm('Bạn có chắc chắn muốn xóa mẫu này không?')) {
            const form = document.getElementById('delete-form');
            const actionUrl = `/mau/delete/${mauId}/`;

            fetch(actionUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`mau-${mauId}`).remove();
                } else {
                    alert('Xóa mẫu thất bại: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Lỗi:', error);
                alert('Có lỗi xảy ra khi xóa mẫu');
            });
        }
    }
</script>
{% endblock %}
